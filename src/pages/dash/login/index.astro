---
import VueLayout from "@/layouts/VueLayout.astro";
import LoginPage from "./_LoginPage.vue";

const { user } = Astro.locals;
import { createAdminClient, createSessionClient, SESSION_COOKIE } from "@/server/appwrite";
import { AppwriteException } from "appwrite";

const params = new URLSearchParams(Astro.request.url.search);
const redirect = params.get("redirect") || "/dash/lists";

if (user.account) {
    const { account } = createSessionClient({ request: Astro.request });
    await account.deleteSession({sessionId: "current"});
    Astro.cookies.delete(SESSION_COOKIE, { path: "/" });
}

if (Astro.request.method === "POST") {
    try {
        const body = await Astro.request.json();
        const { email, password } = body;

        const { account } = createAdminClient();

        const session = await account.createEmailPasswordSession({
            email,
            password,
        });

        Astro.cookies.set(SESSION_COOKIE, session.secret, {
            path: "/",
            expires: new Date(session.expire),
            sameSite: "strict",
            secure: true,
            httpOnly: true,
        });

        try {
            console.log({session});
            const sessionClient = createSessionClient({ session: session.secret });
            const user = await sessionClient.account.get();
            console.log({user});
        } catch (error) {
            if (error instanceof AppwriteException) {
                return new Response(error.response, {
                    status: error.code || 400,
                    headers: { "Content-Type": "application/json" },
                });
            }
            
            return new Response(JSON.stringify({ error: error.message }), {
                status: 400,
                headers: { "Content-Type": "application/json" },
            });
        }

        return new Response("OK", { status: 200 });
    } catch (error) {
        if (error instanceof AppwriteException) {
            return new Response(error.response, {
                status: error.code || 400,
                headers: { "Content-Type": "application/json" },
            });
        }
        
        console.log({error})

        return new Response(JSON.stringify({ error: error.message }), {
            status: 400,
            headers: { "Content-Type": "application/json" },
        });
    }
}

export const prerender = false;
---
<VueLayout user={user}>
    <LoginPage 
        client:only="vue"
        redirect={redirect}
    />
</VueLayout>

